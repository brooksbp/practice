#include "atom.h"
#include <string.h>
#include "assert.h"
#include <limits.h>
#include "mem.h"


#define NELEMS(x) ((sizeof(x))/(sizeof((x)[0])))


static struct atom {
  struct atom *link;
  int len;
  char *str;
} *buckets[2048];

// 256 array maps bytes to random numbers. helps uniformly
// distribute the hash values
static unsigned long scatter[] = {
  767541683, 880234716, 995947696, 45160493,
  641075832, 326664948, 723907568, 609416242,
  587877299, 681317028, 94248511, 963867917,
  334381587, 922638679, 38989697, 51611260,
  19369778, 818649061, 382312243, 442399675,
  402735000, 800979357, 617815819, 834994028,
  578195657, 43571822, 586011861, 873087376,
  142728877, 898632688, 794050611, 860655797,
  34678671, 529226992, 286306926, 830827600,
  972594952, 637061561, 277031033, 711030488,
  435304196, 665007941, 292017594, 514898997,
  395538393, 782316175, 845845396, 910919354,
  282137562, 475922609, 90150793, 760200431,
  459546956, 246614886, 711935791, 770686024,
  756870320, 684900554, 31027223, 541716055,
  692462532, 702813924, 787773889, 456885774,
  998997181, 563847208, 782695401, 778996197,
  623354105, 160249045, 571112898, 20243946,
  319387642, 357673710, 18681851, 487137881,
  951843392, 711196796, 462822338, 504057066,
  572682771, 254104072, 640170274, 87606202,
  862760037, 412452890, 771891676, 759826485,
  969319407, 210724504, 719819025, 452598574,
  83348733, 117670749, 499361237, 393511931,
  456465713, 883463516, 550979912, 509339924,
  631335463, 836557534, 372692779, 722041302,
  644204129, 491918729, 422304208, 52512357,
  837596493, 236431516, 401867937, 695387085,
  701818198, 756822272, 355158661, 9939281,
  169387119, 367798098, 676395983, 778195182,
  765624578, 165922542, 617141667, 631759330,
  921837215, 309129550, 331848018, 466721107,
  302607646, 124504476, 260449144, 801416685,
  109064040, 125166459, 416122085, 357507495,
  936820271, 65881399, 159075042, 958314280,
  378632045, 220772904, 580488559, 933355230,
  312373646, 779621595, 603100713, 811617539,
  124622539, 164922471, 678834763, 604429886,
  148170220, 765343420, 322979234, 759281444,
  329638417, 311345628, 918685797, 833183514,
  176413186, 453585592, 735943789, 849775883,
  219394283, 673964415, 204279285, 729725827,
  890447063, 357011010, 26371568, 386913958,
  904618431, 334235487, 623215904, 141150647,
  172586331, 180943937, 547363497, 8512133,
  670616017, 577600170, 448138128, 614801819,
  839184535, 833023067, 38867316, 484868626,
  837234988, 33525616, 186094580, 39085772,
  817499882, 9830020, 467467127, 595548285,
  177741110, 745941736, 192985990, 312911601,
  701343850, 681093730, 998174574, 412496382,
  226870607, 192950410, 511589559, 987978208,
  158915857, 212467295, 266664280, 270461264,
  744634936, 523830157, 565259308, 701812570,
  965616694, 206839127, 577716570, 866731137,
  407623880, 222335807, 542319765, 810203062,
  142636386, 908576348, 981833683, 875685271,
  695424325, 792241477, 787747355, 718744059,
  458213792, 565321620, 138667454, 678674146,
  626981730, 342948327, 930235564, 155310486,
  762973093, 835252415, 957793026, 347405946,
  2833663, 615259784, 371363984, 933892930,
  703413985, 219302586, 57861119, 428471921,
  649534344, 626286046, 194262583, 298049584
};

int Atom_length(const char *str) {
  struct atom *p;
  int i;
  
  assert(str);
  for (i = 0; i < NELEMS(buckets); i++) {
    for (p = buckets[i]; p; p = p->link) {
      if (p->str == str)
        return p->len;
    }
  }
  assert(0);
  return 0;
}

const char *Atom_new(const char *str, int len) {
  unsigned long h;
  int i;
  struct atom *p;

  assert(str);
  assert(len >= 0);

  for (h = 0, i = 0; i < len; i++) {
    h = (h << 1) + scatter[(unsigned char) str[i]];
  }

  h %= NELEMS(buckets);
  for (p = buckets[h]; p; p = p->link) {
    if (len == p->len) {
      for (i = 0; i < len && p->str[i] == str[i]; )
        i++;
      if (i == len)
        return p->str;
    }
  }

  p = ALLOC(sizeof(*p) + len + 1);
  p->len = len;
  p->str = (char *)(p + 1);
  if (len > 0)
    memcpy(p->str, str, len);
  p->str[len] = '\0';
  p->link = buckets[h];
  buckets[h] = p;
  
  return p->str;
}

const char *Atom_string(const char *str) {
  assert(str);
  return Atom_new(str, stlen(str));
}

const char *Atom_int(long n) {
  char str[43];
  char *s = str + sizeof(str);
  unsigned long m;

  if (n == LONG_MIN)
    m = LONG_MAX + 1UL;
  else if (n < 0)
    m = -n;
  else
    m = n;

  do
    *--s = m % 10 + '0';
  while ((m /= 10) > 0);

  if (n < 0)
    *--s = '-';

  return Atom_new(s, (str + sizeof(str)) - s);
}
